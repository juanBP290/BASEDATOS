<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Base de Datos de Productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .scroll-table-x {
      overflow-x: auto;
      position: relative;
      width: 100%;
    }
    .scroll-table-x::-webkit-scrollbar {
      height: 8px;
    }
    .top-scrollbar {
      height: 18px;
      margin-bottom: -18px;
      background: #fff;
      z-index: 20;
      position: sticky;
      top: 0;
      width: 100%;
      overflow-x: auto;
      display: block;
    }
    .fake-scroll-content {
      width: 1800px;
      height: 1px;
    }
    .fijo {
      min-width: 1800px !important;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-xs">
    <h2 class="text-xl font-semibold mb-4 text-center">Acceso</h2>
    <form id="loginForm" class="space-y-4">
      <div>
        <label class="text-sm font-medium">Usuario</label>
        <input type="text" name="usuario" required class="w-full border px-2 py-1 rounded" autocomplete="off"/>
      </div>
      <div>
        <label class="text-sm font-medium">Contraseña</label>
        <input type="password" name="password" required class="w-full border px-2 py-1 rounded"/>
      </div>
      <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Entrar</button>
      <p id="loginError" class="text-red-600 text-center text-sm hidden">Usuario o contraseña incorrectos</p>
    </form>
  </div>
</div>

<!-- Main Content -->
<div id="mainContent" class="hidden">
  <header class="bg-white shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
      <h1 class="text-2xl font-bold text-gray-900 mb-3 sm:mb-0">Base de Datos de Productos</h1>
      <button id="logoutBtn" class="bg-gray-400 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors duration-200">
        Cerrar sesión
      </button>
    </div>
    <!-- DOS BARRAS DE BUSQUEDA -->
    <div class="max-w-5xl mx-auto px-4 pb-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
      <input id="searchInput" type="text" placeholder="Buscar en toda la base de datos..." class="w-full pl-3 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
      <input id="searchCodigo" type="text" placeholder="Buscar solo por CODIGO, PRODUCTO, MARCA, DESCRIPCIÓN..." class="w-full pl-3 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" />
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- Scroll horizontal arriba SIEMPRE visible -->
    <div class="top-scrollbar scroll-table-x" id="scrollTop">
      <div class="fake-scroll-content"></div>
    </div>
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
      <div class="scroll-table-x" id="scrollBottom">
        <table class="min-w-full divide-y divide-gray-200 fijo" id="productsTable">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-2 py-2 text-xs text-left text-gray-500">CODIGO</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">ANAQUEL</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">CODIGO PRODUCTO</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">MARCA-ANAQUEL</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">TIPO</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">PRODUCTO</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">DESCRIPCIÓN</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">OBERVACIONES</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">PROVEEDOR</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">STOCK FINAL</th>
              <th class="px-2 py-2 text-xs text-left text-gray-500">PRECIO</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
            <!-- Se llena con JS -->
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<script>
  // Tu SheetDB API
  const SHEETDB_API = "https://sheetdb.io/api/v1/yt1a1pctg3qca";
  const USER = "admin";
  const PASS = "1234";

  function isLoggedIn() {
    return localStorage.getItem("sessionActiva") === "SI";
  }
  function setLoggedIn(state) {
    if(state) localStorage.setItem("sessionActiva", "SI");
    else localStorage.removeItem("sessionActiva");
  }

  // Mantiene sesión después de recargar
  if(isLoggedIn()) {
    document.getElementById("loginModal").classList.add("hidden");
    document.getElementById("mainContent").classList.remove("hidden");
    fetchAndRender();
  }

  document.getElementById("loginForm").onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const usuario = form.usuario.value.trim();
    const password = form.password.value;
    if (usuario === USER && password === PASS) {
      setLoggedIn(true);
      document.getElementById("loginModal").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
      fetchAndRender();
    } else {
      document.getElementById("loginError").classList.remove("hidden");
      setTimeout(() => {
        document.getElementById("loginError").classList.add("hidden");
      }, 2000);
    }
  };

  document.getElementById("logoutBtn").onclick = function() {
    setLoggedIn(false);
    window.location.reload();
  };

  // Leer datos de SheetDB
  let entries = [];
  function fetchAndRender() {
    fetch(SHEETDB_API)
      .then(res => res.json())
      .then(data => {
        entries = data.map((e, idx) => ({
          ...e,
          id: idx + 1,
          finalStock: e.finalStock ? parseInt(e.finalStock) : "",
          price: e.price && !isNaN(parseFloat(e.price)) ? parseFloat(e.price) : ""
        }));
        renderTable();
      });
  }

  // Buscadores
  let search1 = "";
  let search2 = "";

  // Render tabla con dos filtros
  function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    let filtered = entries;

    // Primer filtro: búsqueda general (toda la base)
    if(search1.trim()) {
      const t1 = search1.trim().toLowerCase();
      filtered = filtered.filter(e =>
        Object.values(e).some(val =>
          String(val).toLowerCase().includes(t1)
        )
      );
    }

    // Segundo filtro: búsqueda por codigo, codigoproducto, marcaanaquel, product, description
    if(search2.trim()) {
      const t2 = search2.trim().toLowerCase();
      filtered = filtered.filter(e =>
        (e.codigo && e.codigo.toLowerCase().includes(t2)) ||
        (e.codigoproducto && e.codigoproducto.toLowerCase().includes(t2)) ||
        (e.marcaanaquel && e.marcaanaquel.toLowerCase().includes(t2)) ||
        (e.product && e.product.toLowerCase().includes(t2)) ||
        (e.description && e.description.toLowerCase().includes(t2))
      );
    }

    if (filtered.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="11" class="px-6 py-4 text-center text-gray-500">
            No se encontraron resultados
          </td>
        </tr>
      `;
      return;
    }

    filtered.forEach(entry => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-2 py-2">${entry.codigo || ""}</td>
        <td class="px-2 py-2">${entry.anaquel || ""}</td>
        <td class="px-2 py-2">${entry.codigoproducto || ""}</td>
        <td class="px-2 py-2">${entry.marcaanaquel || ""}</td>
        <td class="px-2 py-2">${entry.type || ""}</td>
        <td class="px-2 py-2">${entry.product || ""}</td>
        <td class="px-2 py-2">${entry.description || ""}</td>
        <td class="px-2 py-2">${entry.observations || ""}</td>
        <td class="px-2 py-2">${entry.supplier || ""}</td>
        <td class="px-2 py-2">${entry.finalStock !== undefined && entry.finalStock !== null && entry.finalStock !== "" ? entry.finalStock : ""}</td>
        <td class="px-2 py-2">${entry.price !== "" ? "S/" + Number(entry.price).toFixed(2) : ""}</td>
      `;
      tbody.appendChild(row);
    });
    sincronizarScroll();
  }

  // Dos buscadores independientes
  document.getElementById('searchInput').oninput = function() {
    search1 = this.value;
    renderTable();
  };
  document.getElementById('searchCodigo').oninput = function() {
    search2 = this.value;
    renderTable();
  };

  // SINCRONIZAR SCROLL HORIZONTAL arriba y abajo
  function sincronizarScroll() {
    const scrollTop = document.getElementById('scrollTop');
    const scrollBottom = document.getElementById('scrollBottom');
    scrollTop.scrollLeft = scrollBottom.scrollLeft;
    scrollTop.onscroll = function() {
      scrollBottom.scrollLeft = scrollTop.scrollLeft;
    };
    scrollBottom.onscroll = function() {
      scrollTop.scrollLeft = scrollBottom.scrollLeft;
    };
  }

  // Inicializa scroll sync después de render
  window.onload = () => setTimeout(sincronizarScroll, 500);
</script>
</body>
</html>


